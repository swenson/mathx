// Copyright (c) 2013-2014 Christopher Swenson.
// Copyright (c) 2012 Google, Inc. All Rights Reserved.

// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at

// http://www.apache.org/licenses/LICENSE-2.0

// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package mathx

import (
	"math"
	"testing"
)

func dEquals(a, b float64) bool {
	return math.Abs(a-b) < 1e-6
}

func TestRegulator(t *testing.T) {
	for _, testCase := range regulatorTestCases {
		p := ParseIntPoly(testCase.polyString)
		gotr := p.regulatorRealQuad()
		r := testCase.regulator
		if !dEquals(r, gotr) {
			t.Errorf("Poly %s regulator %f but got %f\n", p, r, gotr)
		}
	}
}

func TestRandomClassNumbers(t *testing.T) {
	for _, testCase := range classNumberTestCases {
		p := ParseIntPoly(testCase.polyString)
		if p.Degree() > 2 {
			continue
		}
		if p.Discriminant().Sign() > 0 {
			continue
		}
		h := testCase.classNumber
		k := MakeNumberField(p)
		hGot := k.ClassNumber()
		if hGot != h {
			t.Errorf("%s expected class number %d got %d, discriminant %s\n", p.String(), h, hGot, p.Discriminant().String())
		}
	}
}

func TestParsePolynomial(t *testing.T) {
	testCases := []string{"x^2 + 5*x - 1001", "x^2", "-1*x", "2*x + 1", "x + 1", "x", "1", "2"}
	for _, testCase := range testCases {
		p := ParseIntPoly(testCase).String()
		if p != testCase {
			t.Errorf("Parsed %s but got %s\n", testCase, p)
		}
	}
}

func TestClassNumber1(t *testing.T) {
	class_number_1_nums := []int{-3, -4, -7, -8, -11, -19, -43, -67, -163}
	class_number_1 := NewIntSet(class_number_1_nums)
	for a := 1; a < 10; a++ {
		for b := -10; b < 10; b++ {
			for c := -10; c < 10; c++ {
				p := NewIntPolynomial64(int64(c), int64(b), int64(a))
				if !p.IsIrreducible() {
					continue
				}
				if p.Discriminant().Sign() > 0 {
					continue
				}
				if !IsFundamentalDiscriminant(p.Discriminant()) {
					continue
				}
				k := MakeNumberField(p)

				if k.ClassNumber() == 1 && !class_number_1.Contains(int(p.Discriminant().Int64())) {
					t.Fail()
				}
			}
		}
	}
}

// from sage
var regulatorTestCases = []struct {
	polyString string
	regulator  float64
}{
	{"x^2 - 2", 0.881374},
	{"x^2 - 3", 1.316958},
	{"x^2 - 5", 0.481212},
	{"x^2 - 6", 2.292432},
	{"x^2 - 7", 2.768659},
	{"x^2 - 10", 1.818446},
	{"x^2 - 11", 2.993223},
	{"x^2 - 13", 1.194763},
	{"x^2 - 14", 3.400084},
	{"x^2 - 15", 2.063437},
	{"x^2 - 17", 2.094713},
	{"x^2 - 19", 5.828937},
	{"x^2 - 21", 1.566799},
	{"x^2 - 22", 5.976344},
	{"x^2 - 23", 3.870767},
	{"x^2 - 26", 2.312438},
	{"x^2 - 29", 1.647231},
	{"x^2 - 30", 3.088970},
	{"x^2 - 31", 8.019613},
	{"x^2 - 33", 3.828168},
	{"x^2 - 34", 4.248291},
	{"x^2 - 35", 2.477889},
	{"x^2 - 37", 2.491780},
	{"x^2 - 38", 4.303882},
	{"x^2 - 39", 3.911623},
	{"x^2 - 41", 4.159127},
	{"x^2 - 42", 3.256614},
	{"x^2 - 43", 8.848509},
	{"x^2 - 46", 10.792818},
	{"x^2 - 47", 4.564240},
	{"x^2 - 51", 4.605070},
	{"x^2 - 53", 1.965720},
	{"x^2 - 55", 5.181752},
	{"x^2 - 57", 5.710416},
	{"x^2 - 58", 5.288293},
	{"x^2 - 59", 6.966023},
	{"x^2 - 61", 3.664218},
	{"x^2 - 62", 4.836219},
	{"x^2 - 65", 2.776472},
	{"x^2 - 66", 4.867475},
	{"x^2 - 67", 11.489493},
	{"x^2 - 69", 3.217272},
	{"x^2 - 70", 6.218596},
	{"x^2 - 71", 8.847935},
	{"x^2 - 73", 7.666690},
	{"x^2 - 74", 4.454482},
	{"x^2 - 77", 2.184644},
	{"x^2 - 78", 4.663350},
	{"x^2 - 79", 5.075135},
	{"x^2 - 82", 2.893444},
	{"x^2 - 83", 5.099829},
	{"x^2 - 85", 2.209348},
	{"x^2 - 86", 9.943189},
	{"x^2 - 87", 4.025033},
	{"x^2 - 89", 6.907756},
	{"x^2 - 91", 8.054523},
	{"x^2 - 93", 3.366105},
	{"x^2 - 94", 15.271002},
	{"x^2 - 95", 4.356544},
	{"x^2 - 97", 9.324383},
}

var classNumberTestCases = []struct {
	classNumber int
	polyString  string
}{
	{1, "x^2 - x + 1"},
	{1, "x^2 + x + 1"},
	{2, "x^2 - x + 9"},
	{1, "x^2 + x - 1"},
	{1, "x^2 + 2*x + 3"},
	{1, "x^2 - 3*x - 5"},
	{2, "x^2 + 13*x + 1"},
	{2, "x^2 + 10*x - 1"},
	{1, "x^2 - 3"},
	{1, "x^2 - 2*x + 2"},
	{1, "x^2 - x - 1"},
	{1, "x^2 + 4"},
	{1, "x^2 - x - 8"},
	{2, "x^2 - 9*x + 4"},
	{1, "x^2 + 2"},
	{1, "x^2 + x - 3"},
	{1, "x^2 - x + 2"},
	{3, "x^2 + x + 6"},
	{1, "x^2 - x - 3"},
	{1, "x^2 + 4*x - 2"},
	{2, "x^2 - x + 4"},
	{2, "x^2 + x + 13"},
	{1, "x^2 + 9*x + 6"},
	{1, "x^2 - x + 3"},
	{1, "x^2 + 2*x - 2"},
	{2, "x^2 - 12*x + 1"},
	{1, "x^2 + 5*x - 1"},
	{1, "x^2 + 1"},
	{1, "x^2 - 5*x + 5"},
	{1, "x^2 + 2*x - 1"},
	{1, "x^2 - 51*x + 1"},
	{1, "x^2 - 3*x + 1"},
	{1, "x^2 + x - 23"},
	{2, "x^2 - 20*x - 6"},
	{1, "x^2 + 3*x + 1"},
	{1, "x^2 - 18*x + 1"},
	{2, "x^2 + 2*x + 6"},
	{1, "x^2 + x + 2"},
	{1, "x^2 + 3"},
	{1, "x^2 - 4*x + 5"},
	{11, "x^2 - 72*x - 1"},
	{1, "x^2 - 5"},
	{1, "x^2 - 14*x + 1"},
	{7, "x^2 - x + 160"},
	{1, "x^2 + x + 5"},
	{1, "x^2 + 13*x + 5"},
	{4, "x^2 - 11*x - 6"},
	{1, "x^2 - 8*x + 2"},
	{1, "x^2 - 3*x - 8"},
	{1, "x^2 + 11"},
	{1, "x^2 - 6"},
	{1, "x^2 + 5*x + 7"},
	{1, "x^2 - 1523*x + 1"},
	{1, "x^2 + 17*x - 1"},
	{1, "x^2 + x - 4"},
	{1, "x^2 + 2*x + 2"},
	{2, "x^2 - 6*x - 1"},
	{1, "x^2 - 4*x + 1"},
	{1, "x^2 + 3*x - 2"},
	{2, "x^2 + x + 4"},
	{1, "x^2 + x - 18"},
	{1, "x^2 - 15*x - 4"},
	{2, "x^2 - 19*x - 1"},
	{3, "x^2 + x + 8"},
	{8, "x^2 + 210"},
	{4, "x^2 - x + 10"},
	{1, "x^2 - x - 138"},
	{1, "x^2 - 2*x - 1"},
	{1, "x^2 - x - 4"},
	{1, "x^2 + 7*x - 1"},
	{1, "x^2 + 3*x - 1"},
	{1, "x^2 - 13*x - 2"},
	{1, "x^2 - 22*x - 3"},
	{1, "x^2 + 2*x - 74"},
	{2, "x^2 + 10"},
	{3, "x^2 + 31"},
	{1, "x^2 + 10*x + 13"},
	{2, "x^2 + 6*x - 1"},
	{1, "x^2 - 7*x - 3"},
	{1, "x^2 + 2*x - 6"},
	{1, "x^2 + 22*x + 8"},
	{3, "x^2 - 17*x - 8"},
	{2, "x^2 + 2*x + 7"},
	{1, "x^2 + 6*x + 2"},
	{1, "x^2 + 3*x + 4"},
	{1, "x^2 + 4*x - 10"},
	{1, "x^2 - x - 5"},
	{2, "x^2 + 6"},
	{1, "x^2 - 3*x - 1"},
	{1, "x^2 + 2*x + 4"},
	{1, "x^2 + 31*x - 4"},
	{1, "x^2 + 10*x + 1"},
	{2, "x^2 + 9*x - 1"},
	{1, "x^2 - 2*x + 3"},
	{1, "x^2 - 13*x - 1"},
	{3, "x^2 - x + 8"},
	{1, "x^2 - 12*x - 1"},
	{1, "x^2 - 21"},
	{1, "x^2 - 5*x + 1"},
	{1, "x^2 - 2"},
	{1, "x^3 - x - 3"},
	{6, "x^3 + 10*x^2 + 1"},
	{1, "x^3 + 3*x^2 - x + 1"},
	{1, "x^3 + x^2 - x + 31"},
	{1, "x^3 - x^2 - x - 1"},
	{1, "x^3 - x^2 - 4*x + 2"},
	{19, "x^3 + 88*x^2 - x + 1"},
	{1, "x^3 - 5*x - 3"},
	{1, "x^3 + 2*x^2 - x + 1"},
	{4, "x^3 - x + 49"},
	{1, "x^3 + 4*x^2 + 6"},
	{1, "x^3 + 39*x^2 + x - 2"},
	{1, "x^3 - x + 1"},
	{2, "x^3 - 4*x^2 - 1"},
	{3, "x^3 + 9*x^2 - x + 1"},
	{1, "x^3 - x - 1"},
	{3, "x^3 - 19*x^2 - 8*x - 1"},
	{1, "x^3 - 7*x^2 + x + 1"},
	{1, "x^3 + x^2 + 1"},
	{1, "x^3 + 5*x - 13"},
	{1, "x^3 - 2*x^2 - x + 3"},
	{1, "x^3 - x^2 + 2*x + 1"},
	{1, "x^3 + 5*x - 3"},
	{1, "x^3 - x^2 - 2*x + 1"},
	{1, "x^3 - x^2 - 3*x - 2"},
	{1, "x^3 - 2*x^2 - 25*x - 2"},
	{1, "x^3 + x - 1"},
	{1, "x^3 - x^2 + x - 3"},
	{1, "x^3 + x^2 + x - 1"},
	{8, "x^3 - 32*x^2 - 2"},
	{1, "x^3 + x^2 + 2*x - 1"},
	{1, "x^3 - x^2 - 5*x + 1"},
	{1, "x^3 + 2*x + 1"},
	{1, "x^3 + x^2 + 2*x - 2"},
	{1, "x^3 + 6*x^2 + 2*x + 2"},
	{1, "x^3 - x^2 - 18*x + 11"},
	{3, "x^3 + 20*x^2 + x - 1"},
	{1, "x^3 - 16*x^2 + 2*x + 1"},
	{1, "x^3 + 2*x^2 + x + 5"},
	{1, "x^3 + 2*x^2 - 24*x + 2"},
	{1, "x^3 - 6*x^2 + x + 1"},
	{1, "x^3 + 2*x^2 - x + 3"},
	{1, "x^3 - x^2 - x - 3"},
	{1, "x^3 + x^2 - 81*x - 1"},
	{1, "x^3 + x^2 - x + 1"},
	{1, "x^3 - x^2 + x + 1"},
	{1, "x^3 - 3*x - 1"},
	{1, "x^3 + 5*x^2 + x - 2"},
	{1, "x^3 + x^2 - x + 3"},
	{1, "x^3 - 5*x^2 + x - 1"},
	{6, "x^3 - x^2 + x - 27"},
	{1, "x^3 + x^2 - 7"},
	{3, "x^3 - x^2 + 553*x - 3"},
	{1, "x^3 - x^2 - 13*x - 1"},
	{1, "x^3 + x^2 + x + 2"},
	{1, "x^3 - x^2 - x - 11"},
	{2, "x^3 - x^2 - 32*x + 1"},
	{1, "x^3 + 3*x - 1"},
	{5, "x^3 - x^2 + x - 102"},
	{4, "x^3 - 64*x + 2"},
	{1, "x^3 - 2*x + 6"},
	{1, "x^3 + 12*x^2 + x + 2"},
	{1, "x^3 + 5*x^2 - x + 4"},
	{1, "x^3 - x^2 - 1"},
	{2, "x^3 - 5*x^2 - 3*x + 176"},
	{1, "x^3 - 8*x + 1"},
	{1, "x^3 + x^2 - 2*x + 1"},
	{1, "x^3 - 4*x^2 + x - 6"},
	{2, "x^3 + x^2 + 16*x - 1"},
	{1, "x^3 + 4"},
	{3, "x^3 - 12*x^2 + 1"},
	{1, "x^3 + x^2 + x - 5"},
	{1, "x^3 + 11*x^2 + 2*x + 16"},
	{2, "x^3 + 13*x^2 + 2*x + 1"},
	{4, "x^3 - 2*x^2 + 4*x - 9"},
	{1, "x^3 - 2*x^2 + x - 10"},
	{1, "x^3 + 2*x^2 - x - 3"},
	{1, "x^3 + x^2 - 5*x - 4"},
	{1, "x^3 + x^2 + 5*x - 2"},
	{1, "x^3 - x^2 + 5"},
	{4, "x^3 + 12*x^2 + 2*x + 1"},
	{5, "x^3 - 13*x^2 + x - 1"},
	{1, "x^3 + x^2 - 1"},
	{2, "x^3 + 14*x^2 + 2*x - 1"},
	{1, "x^3 - 3*x^2 + x - 2"},
	{1, "x^3 - x^2 + x - 14"},
	{1, "x^3 + x^2 - 4*x + 7"},
	{1, "x^3 - x^2 - x + 3"},
	{1, "x^3 - x^2 + 2*x - 1"},
	{1, "x^3 + 9*x^2 - 1"},
	{2, "x^3 + x^2 - 664*x - 1"},
	{1, "x^3 + x^2 - 2*x - 1"},
	{1, "x^3 + 2*x - 7"},
	{1, "x^3 + 9*x^2 + 3"},
	{1, "x^3 - x^2 - 4*x + 1"},
	{1, "x^3 - 55*x^2 + 4"},
	{2, "x^3 - 26*x^2 - 2*x + 1"},
	{2, "x^3 - 2*x^2 + 6*x - 1"},
	{1, "x^3 + x^2 + 2*x + 1"},
	{1, "x^3 - 3*x^2 - x + 5"},
	{1, "x^4 - x^2 - 185*x - 13"},
	{1, "x^4 - 3*x^3 + 3*x^2 - x - 6"},
	{1, "x^4 - x^3 - x^2 - 2"},
	{1, "x^4 + x^3 + x^2 + 5*x + 1"},
	{1, "x^4 + 3*x^3 + x^2 + x - 2"},
	{1, "x^4 + 5*x^3 - x^2 - 5*x + 1"},
	{1, "x^4 - 2*x^3 - 1"},
	{1, "x^4 + x^3 + 2*x^2 - x + 1"},
	{1, "x^4 + 2*x^3 - 6*x^2 - 2*x + 3"},
	{1, "x^4 + 4*x^2 - x + 4"},
	{10, "x^4 + x^3 - 27*x - 1"},
	{1, "x^4 + x^3 + 3*x^2 - 2"},
	{1, "x^4 + x^3 + 1"},
	{1, "x^4 - 5*x^2 - 2"},
	{2, "x^4 + 10*x^3 - 7"},
	{1, "x^4 - x^3 - 1"},
	{1, "x^4 - 3*x^3 - x^2 - 4"},
	{2, "x^4 + 4*x^2 + 1"},
	{1, "x^4 + x^3 - x - 4"},
	{1, "x^4 + x^3 + 6*x^2 - 3*x - 1"},
	{5, "x^4 + 38*x^2 - x - 8"},
	{1, "x^4 - 2*x^3 + 4*x^2 + 15"},
	{1, "x^4 + x^3 + 4*x^2 + 1"},
	{1, "x^4 + x^3 - x^2 - x - 1"},
	{3, "x^4 + 2*x^3 + x^2 - 4*x + 8"},
	{1, "x^4 - x^3 - x^2 - 2*x + 1"},
	{1, "x^4 - 4*x^2 + 1"},
	{1, "x^4 - 3*x^2 - 3*x + 1"},
	{1, "x^4 - x^3 - x + 18"},
	{12, "x^4 + 2*x^3 + 11*x^2 - x + 1"},
	{1, "x^4 + x^3 - x^2 + 4*x - 1"},
	{1, "x^4 + 5*x^3 - 1"},
	{1, "x^4 + x^3 + x^2 + x + 1"},
	{3, "x^4 + 19*x^3 + 3*x^2 + x + 2"},
	{2, "x^4 + 16*x^2 + x + 7"},
	{1, "x^4 + 2*x^3 - x^2 - 2*x + 9"},
	{1, "x^4 + 4*x^3 - x^2 - x - 48"},
	{1, "x^4 - x^3 + 3*x^2 + x - 3"},
	{2, "x^4 - x^3 + 129*x^2 - x + 4"},
	{1, "x^4 + 2*x^3 + 2*x^2 - 3*x - 1"},
	{1, "x^4 + x^3 + x^2 + 3*x + 1"},
	{1, "x^4 + x^2 + 3*x - 2"},
	{1, "x^4 - 5*x^3 + 3*x^2 - 3*x - 1"},
	{1, "x^4 - 2*x^2 - x - 5"},
	{1, "x^4 + 2*x^3 - 10*x^2 + x + 1"},
	{1, "x^4 - x^3 + 3*x^2 + x - 2"},
	{4, "x^4 - 476*x^3 - 3*x^2 - x - 3"},
	{1, "x^4 - x^3 - x^2 + x - 1"},
	{12, "x^4 + x^3 - 53*x^2 - 1"},
	{1, "x^4 + 12*x^3 + 1"},
	{1, "x^4 + x^3 - 3*x^2 - x - 1"},
	{1, "x^4 + 12*x^2 - 2*x - 5"},
	{1, "x^4 - x^3 + 2*x^2 + 2*x + 12"},
	{1, "x^4 + 5*x^2 - 5*x + 1"},
	{1, "x^4 + 3*x^3 + x^2 - x + 3"},
	{1, "x^4 + 5*x^3 - x^2 + 5*x + 3"},
	{2, "x^4 - x^3 + 4*x^2 + x + 4"},
	{1, "x^4 + 3*x^3 - 14*x^2 - 2*x - 4"},
	{1, "x^4 - 11*x^2 + x + 1"},
	{1, "x^4 - x^3 + x^2 - x - 2"},
	{1, "x^4 + 3*x^3 - 5*x^2 - 3*x + 2"},
	{1, "x^4 + 3*x^3 - 3*x^2 - x - 4"},
	{1, "x^4 - 3*x^3 - 1"},
	{2, "x^4 + x^3 + 28*x^2 + x + 2"},
	{1, "x^4 + 11*x^3 + 6*x^2 - 65*x + 1"},
	{1, "x^4 + x^3 - 29*x^2 + x - 2"},
	{3, "x^4 - x^3 + 2*x^2 + 7*x - 8"},
	{1, "x^4 - 2*x^3 - 21*x^2 + 4*x - 1"},
	{1, "x^4 + 2*x^2 + x - 1"},
	{1, "x^4 - 20*x^3 - 4*x^2 - 8*x + 2"},
	{1, "x^4 + x^3 - 3*x^2 - x + 5"},
	{1, "x^4 + x^2 - 1"},
	{1, "x^4 + 5*x^3 - x^2 - x - 1"},
	{1, "x^4 - x^3 - x - 2"},
	{1, "x^4 + x^2 + x + 1"},
	{1, "x^4 - x^3 - x^2 - 5*x - 1"},
	{1, "x^4 + 7*x^3 + x^2 - 8*x - 15"},
	{2, "x^4 + 7*x^3 + x^2 + 11*x + 1"},
	{1, "x^4 + x^3 - 10*x^2 - x + 2"},
	{1, "x^4 - x^2 + x + 2"},
	{1, "x^4 + 2*x^3 + 12*x^2 - 2*x - 1"},
	{1, "x^4 - x^3 + 4*x^2 + 2"},
	{1, "x^4 - x^3 - 9*x^2 + 3*x - 2"},
	{1, "x^4 + x^3 + 8*x^2 + x - 2"},
	{1, "x^4 + x^3 - 5"},
	{1, "x^4 - 2*x^2 + 17*x + 2"},
	{1, "x^4 - x^3 + 3*x - 1"},
	{1, "x^4 + x^3 - 2*x^2 + 1"},
	{1, "x^4 - 2*x^3 - x^2 - 2*x - 1"},
	{2, "x^4 + 9*x^3 - x^2 + x + 1"},
	{1, "x^4 - 2*x^3 + 2*x + 1"},
	{1, "x^4 - 3*x^3 + x^2 + 7*x - 2"},
	{1, "x^4 - 2*x^3 + x^2 - 24*x - 1"},
	{1, "x^4 - 6*x^3 + 3*x^2 + x - 3"},
	{1, "x^4 + x^3 + 7*x^2 - 69*x + 4"},
	{1, "x^4 + 5*x^3 - x + 1"},
	{3, "x^4 + 6*x^3 - x^2 + x - 1"},
	{1, "x^4 + x^3 - 4*x - 1"},
	{1, "x^4 + 12*x^2 - 2*x + 7"},
	{1, "x^4 + 2*x^2 + 5*x - 1"}}
